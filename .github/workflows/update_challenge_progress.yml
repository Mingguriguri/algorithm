name: Update Challenge Progress

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  update_progress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run extract_pr_data.py
        run: python extract_pr_data.py

      - name: Run update_scoreboard.py
        run: python update_scoreboard.py

      - name: Commit updated scoreboard.json
        run: |
          git config --global user.name "${{ secrets.GIT_USER_NAME }}"
          git config --global user.email "${{ secrets.GIT_USER_EMAIL }}"
          git add ../challenge/scoreboard.json
          git commit -m "Update challenge scoreboard" || echo "No changes to commit"
          git push

      - name: Post PR Comment with progress
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const scoreboard = JSON.parse(fs.readFileSync('scoreboard.json', 'utf8'));
            const prNumber = context.payload.pull_request.number;
            let commentBody = "### Challenge Progress Update\n\n";
            for (const user in scoreboard) {
              commentBody += `**${user}**:\n`;
              for (const type in scoreboard[user]) {
                if (type === "achieved") continue;
                const count = scoreboard[user][type].length;
                const achieved = scoreboard[user]["achieved"][type] ? "✅" : "❌";
                commentBody += `- **${type}**: ${count} 문제 (${achieved})\n`;
              }
              commentBody += "\n";
            }
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
